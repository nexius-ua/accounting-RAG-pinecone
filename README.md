# Legal RAG Pinecone

Система семантичного пошуку по українських юридичних документах з використанням Pinecone vector database.

## Зміст

- [Структура проекту](#структура-проекту)
- [Швидкий старт](#швидкий-старт)
- [Інструкції](#інструкції)
  - [Додавання нових документів](#додавання-нових-документів)
  - [Оновлення існуючих документів](#оновлення-існуючих-документів)
  - [Видалення документів](#видалення-документів)
- [Як працює система](#як-працює-система)
  - [Алгоритм захисту від збоїв (Staging)](#алгоритм-захисту-від-збоїв-staging)
  - [Алгоритм формування чанків](#алгоритм-формування-чанків)
- [Трекінг та логування](#трекінг-та-логування)

---

## Структура проекту

```
legal-RAG-pinecone/
│
├── source_docs/              # ← СЮДИ кладіть нові .md документи
│
├── archived_source_docs/     # Оброблені оригінали (автоматично)
├── archived_chunks/          # Архів чанків (backup)
├── chunks/                   # Staging area (тимчасово)
│
├── scripts/
│   ├── .env                  # API ключі (не в git)
│   ├── chunk_and_upload.py   # Головний скрипт
│   ├── download_chunks.py    # Завантаження backup з Pinecone
│   ├── sync_tracking.py      # Синхронізація трекінгу
│   ├── tracking.json         # База завантажених файлів
│   └── logs/                 # Логи та звіти
│
└── CLAUDE.md                 # Інструкції для AI
```

---

## Швидкий старт

```bash
# 1. Активувати virtual environment
venv\Scripts\activate        # Windows
source venv/bin/activate     # Linux/Mac

# 2. Покласти документи в source_docs/
copy "новий_документ.md" source_docs/

# 3. Запустити обробку
python scripts/chunk_and_upload.py
```

---

## Інструкції

### Додавання нових документів

**Крок 1.** Покладіть `.md` файл(и) в папку `source_docs/`:

```
source_docs/
└── Новий юридичний аналіз.md    ← ваш файл
```

**Крок 2.** Запустіть скрипт:

```bash
python scripts/chunk_and_upload.py
```

**Крок 3.** Перевірте результат:
- Консоль покаже прогрес обробки
- Файл автоматично переміститься в `archived_source_docs/`
- Чанки збережуться в `archived_chunks/`
- `tracking.json` оновиться

```
============================================================
  ФІНАЛЬНИЙ ЗВІТ
============================================================
Оброблено файлів: 1
Створено чанків: 12
Завантажено чанків: 12

Файли:
  • Новий юридичний аналіз.md: 12 chunks
```

---

### Оновлення існуючих документів

Система автоматично визначає зміни по MD5-хешу вмісту.

**Крок 1.** Візьміть файл з архіву та відредагуйте:

```bash
# Скопіюйте з архіву в робочу папку
copy "archived_source_docs\Gem 5 NDA Analysis.md" "source_docs\"

# Відредагуйте файл
notepad "source_docs\Gem 5 NDA Analysis.md"
```

**Крок 2.** Запустіть скрипт:

```bash
python scripts/chunk_and_upload.py
```

**Що відбудеться:**

```
--- КРОК 3: Аналіз змін ---
  [CHANGED] Gem 5 NDA Analysis.md (old: 8 chunks)

Підсумок:
  Нових файлів: 0
  Змінених файлів: 1
  Застарілих чанків для видалення: 8

--- КРОК 4: Видалення застарілих чанків ---
  Видалено batch: 8 IDs
```

Система автоматично:
1. Видалить старі чанки з Pinecone
2. Створить нові чанки
3. Завантажить їх
4. Оновить трекінг

---

### Видалення документів

Для повного видалення документа з системи:

**Варіант А: Ручне видалення**

```python
from pinecone import Pinecone
import json

# Підключення
pc = Pinecone(api_key="your-key")
index = pc.Index("legal-docs-ua")

# Знайти chunk_ids в tracking.json
tracking = json.load(open("scripts/tracking.json"))
chunk_ids = tracking["files"]["filename.md"]["chunk_ids"]

# Видалити з Pinecone
index.delete(namespace="default", ids=chunk_ids)

# Видалити з tracking.json (вручну)
```

**Варіант Б: Скрипт (TODO)**

---

## Як працює система

### Алгоритм захисту від збоїв (Staging)

Система використовує staging workflow для гарантії цілісності даних:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         STAGING WORKFLOW                                │
└─────────────────────────────────────────────────────────────────────────┘

  ПОЧАТОК
     │
     ▼
┌─────────────┐
│ source_docs/│  ← Користувач кладе .md файли
│  new.md     │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 5: CHUNKING (STAGING)                                  │
│  ┌─────────────┐    ┌─────────────┐                          │
│  │ source_docs/│───▶│   chunks/   │  Staging area            │
│  │  new.md     │    │ new.md.json │  (тимчасове сховище)     │
│  └─────────────┘    └─────────────┘                          │
└──────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 6: UPLOAD                                              │
│                                                              │
│  chunks/new.md.json ────────────────▶ [PINECONE]             │
│                         upsert_records()                     │
│                                                              │
│  ⚠️  Якщо помилка тут - файли залишаються в staging!        │
│      Нічого не втрачено, можна повторити.                    │
└──────────────────────────────────────────────────────────────┘
       │
       ▼  (тільки після успішного upload)
┌──────────────────────────────────────────────────────────────┐
│  КРОК 7-8: ВЕРИФІКАЦІЯ + АРХІВУВАННЯ                         │
│                                                              │
│  ┌─────────────┐         ┌───────────────────┐               │
│  │   chunks/   │────────▶│ archived_chunks/  │               │
│  │ new.md.json │  move   │    new.md.json    │               │
│  └─────────────┘         └───────────────────┘               │
│                                                              │
│  ┌─────────────┐         ┌───────────────────┐               │
│  │ source_docs/│────────▶│archived_source_   │               │
│  │  new.md     │  move   │docs/new.md        │               │
│  └─────────────┘         └───────────────────┘               │
└──────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 9: ОНОВЛЕННЯ TRACKING                                  │
│                                                              │
│  tracking.json ← оновлення тільки після архівування          │
└──────────────────────────────────────────────────────────────┘
       │
       ▼
   ЗАВЕРШЕНО ✓


┌─────────────────────────────────────────────────────────────────────────┐
│                      ЗАХИСТ ВІД ЗБОЇВ                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Збій на етапі:          Що відбувається:         Як відновити:         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  CHUNKING                Чанки в chunks/          Просто перезапустити  │
│  (staging)               Source в source_docs/    скрипт                │
│                                                                         │
│  UPLOAD                  Чанки в chunks/          Просто перезапустити  │
│  (до Pinecone)           Source в source_docs/    скрипт                │
│                          tracking.json НЕ         (скрипт побачить      │
│                          оновлений                файли як нові)        │
│                                                                         │
│  АРХІВУВАННЯ             Upload успішний          Вручну перемістити    │
│  (після upload)          Дані в Pinecone є        файли або sync        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Ключовий принцип:** Файли переміщуються в архів ТІЛЬКИ після успішного завантаження в Pinecone.

---

### Алгоритм формування чанків

Система розбиває текст на смислові блоки, зберігаючи цілісність речень та абзаців:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    АЛГОРИТМ CHUNKING                                    │
└─────────────────────────────────────────────────────────────────────────┘

                      ВХІДНИЙ ТЕКСТ
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 1: РОЗДІЛЕННЯ ПО АБЗАЦАХ                               │
│                                                              │
│  Regex: \n\s*\n (подвійний перенос рядка)                    │
│                                                              │
│  "Перший абзац тексту.        ┌──────────────────┐           │
│                          ────▶│ Абзац 1          │           │
│   Другий абзац тексту.        ├──────────────────┤           │
│                          ────▶│ Абзац 2          │           │
│   Третій абзац тексту."       ├──────────────────┤           │
│                          ────▶│ Абзац 3          │           │
│                               └──────────────────┘           │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 2: ОБРОБКА КОЖНОГО АБЗАЦУ                              │
│                                                              │
│              ┌─────────────────────────┐                     │
│              │  Абзац ≤ 2000 символів? │                     │
│              └───────────┬─────────────┘                     │
│                    │           │                             │
│                   YES         NO                             │
│                    │           │                             │
│                    ▼           ▼                             │
│           ┌────────────┐ ┌────────────────────────┐          │
│           │ Додати до  │ │ Розбити по реченнях:   │          │
│           │ поточного  │ │ Regex: (?<=[.!?])\s+   │          │
│           │ чанка      │ │                        │          │
│           └────────────┘ │ "Речення 1. Речення 2."│          │
│                          │        │               │          │
│                          │        ▼               │          │
│                          │ ┌────────────┐         │          │
│                          │ │ Речення 1  │         │          │
│                          │ ├────────────┤         │          │
│                          │ │ Речення 2  │         │          │
│                          │ └────────────┘         │          │
│                          └────────────────────────┘          │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  КРОК 3: НАКОПИЧЕННЯ В ЧАНКИ                                 │
│                                                              │
│  Параметри:                                                  │
│  • CHUNK_SIZE_CHARS = 2000 (~500 токенів для української)    │
│  • MIN_CHUNK_CHARS = 100 (ігнорувати надто короткі)          │
│                                                              │
│  ┌─────────────────────────────────────────────┐             │
│  │ Поточний чанк                               │             │
│  │ ─────────────────────                       │             │
│  │ "Абзац 1 тексту про NDA.                    │             │
│  │                                             │             │
│  │  Абзац 2 продовжує тему."                   │             │
│  │                     ▲                       │             │
│  │                     │ 850 символів          │             │
│  └─────────────────────┼───────────────────────┘             │
│                        │                                     │
│         ┌──────────────┴──────────────┐                      │
│         │ Новий абзац (600 символів)  │                      │
│         └──────────────┬──────────────┘                      │
│                        │                                     │
│              ┌─────────┴─────────┐                           │
│              │ 850 + 600 ≤ 2000? │                           │
│              └─────────┬─────────┘                           │
│                   │         │                                │
│                  YES       NO                                │
│                   │         │                                │
│                   ▼         ▼                                │
│            ┌──────────┐ ┌───────────────────┐                │
│            │ Додати   │ │ Зберегти поточний │                │
│            │ до       │ │ як chunk[n]       │                │
│            │ поточного│ │ Почати новий      │                │
│            └──────────┘ └───────────────────┘                │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  РЕЗУЛЬТАТ                                                   │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Chunk 0 (1850 символів)                             │     │
│  │ ───────────────────────────────────────────────────  │     │
│  │ "Перший абзац про основи NDA...                     │     │
│  │                                                     │     │
│  │  Другий абзац розвиває тему конфіденційності.       │     │
│  │                                                     │     │
│  │  Третій абзац про практичне застосування."          │     │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Chunk 1 (1640 символів)                             │     │
│  │ ───────────────────────────────────────────────────  │     │
│  │ "Четвертий абзац про юридичні наслідки...           │     │
│  │                                                     │     │
│  │  П'ятий абзац із прикладами з практики."            │     │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ✓ Кожен чанк закінчується на межі абзацу або речення       │
│  ✓ Немає розрізання посеред слова чи фрази                  │
│  ✓ Зберігається смисловий контекст                          │
└──────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                      ПРИКЛАД РОБОТИ                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ВХІД:                                                                  │
│  ─────                                                                  │
│  "## Пункт 1. Визначення NDA                                            │
│                                                                         │
│   NDA (Non-Disclosure Agreement) - це угода про нерозголошення          │
│   конфіденційної інформації між сторонами.                              │
│                                                                         │
│   ## Пункт 2. Елементи NDA                                              │
│                                                                         │
│   Кожна NDA повинна містити: визначення конфіденційної інформації,      │
│   зобов'язання сторін, строк дії та відповідальність за порушення."     │
│                                                                         │
│                                                                         │
│  ОБРОБКА:                                                               │
│  ────────                                                               │
│  1. Розділення по \n\n → 4 абзаци                                       │
│  2. Абзац "## Пункт 1..." (24 симв) → додати до чанка                   │
│  3. Абзац "NDA (Non-Disclosure..." (98 симв) → додати до чанка          │
│  4. Абзац "## Пункт 2..." (22 симв) → додати до чанка                   │
│  5. Абзац "Кожна NDA..." (134 симв) → додати до чанка                   │
│  6. Кінець тексту → зберегти чанк (278 символів)                        │
│                                                                         │
│                                                                         │
│  ВИХІД:                                                                 │
│  ──────                                                                 │
│  [Chunk 0]: "## Пункт 1. Визначення NDA\n\nNDA (Non-Disclosure          │
│              Agreement)...\n\n## Пункт 2. Елементи NDA\n\nКожна         │
│              NDA повинна містити..."                                    │
│                                                                         │
│  ✓ Один логічний блок про NDA                                           │
│  ✓ Заголовки залишилися з відповідним контентом                         │
│  ✓ Жодного розриву посеред речення                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Трекінг та логування

### tracking.json

Зберігає інформацію про всі завантажені файли:

```json
{
  "index": "legal-docs-ua",
  "namespace": "default",
  "last_updated": "2025-12-01T15:30:00",
  "files": {
    "Gem 5 NDA Analysis.md": {
      "content_hash": "a1b2c3d4e5f6...",  // MD5 хеш вмісту
      "chunk_ids": ["abc123", "def456"],   // IDs в Pinecone
      "chunks_count": 2,
      "uploaded_at": "2025-12-01T15:30:00",
      "source": "archived_source_docs"
    }
  }
}
```

### Логи (scripts/logs/)

Кожен запуск створює:
- `upload_YYYYMMDD_HHMMSS.log` - текстовий лог
- `report_YYYYMMDD_HHMMSS.json` - структурований звіт

```
scripts/logs/
├── upload_20251201_153000.log
├── report_20251201_153000.json
├── upload_20251201_160000.log
└── report_20251201_160000.json
```

---

## Команди

| Дія | Команда |
|-----|---------|
| Завантажити нові документи | `python scripts/chunk_and_upload.py` |
| Завантажити backup з Pinecone | `python scripts/download_chunks.py` |
| Синхронізувати tracking | `python scripts/sync_tracking.py` |
| Запустити тести | `python -m pytest scripts/ -v` |

---

## Ліцензія

MIT
